{% extends "base.html" %}
{% load static %}
{% block content %}
{% include 'components/adm/menuAdm.html' %}
{% csrf_token %}
{% include 'components/adm/popUpAdicionarProduto.html'%}

<link rel="stylesheet" href="{% static 'api/css/AdmCss/campanhas.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<div class="container" id="container-campanhas">

    
    <div class="campanhas_pre">
        <div class="campo_pesquisar" id="campo-pesquisar">
            <div class="pesquisar">
                <img class="lupa" src="{% static 'api/img/pesquisa.png' %}" alt="" />
                <input
                    class="pesquisar_campanha"
                    id="barraBusca"
                    name="termo"
                    type="search"
                    placeholder="Pesquisar Campanha"
                />
            </div>
        </div>
        <div class="cabecalho">
            <div class="cabecalho_titulo">
                <h1 id="titulo-campanhas">Campanhas Criadas</h1>
                <div class="linha"></div>
            </div>
            <div class="cabecalho_btnexportar">
                <button
                    type="button"
                    class="buttonCriarCampanha"
                    value="5"
                    id="botao-criar-campanha"
                >
                    <img src="{% static 'api/img/criar_campanha.png' %}" alt="Exportar" />
                    Criar Campanha
                </button>
            </div>
        </div>

        <div class="campanha">
            <div class="cabecalho-campanha">
                <div class="tabela_campanha_cabecalho_nome" id="coluna-nome">
                    <h2>Nome</h2>
                    <img src="{% static 'api/img/sort.png' %}" alt="Nome" style="width: 24px; height: 24px;" />
                </div>
                <div class="tabela_campanha_cabecalho_termino" id="coluna-termino">
                    <h2>Término</h2>
                </div>
            </div>

            <div id="corpo-tabela-predefinida" class="tabela_campanha">
                <div id="corpo-tabela">
                    {% for campanha in campanhas %}
                    <div class="tr-campanha" id="linha-campanha-{{ campanha.id }}">
                        <div class="tabela_campanha_conteudo" data-nome="{{ campanha.nome|lower }}">
                            <div class="tabela_campanha_conteudo_dado1">
                                <div
                                    class="circle"
                                    style="background-color: {% if campanha.is_active %}#00cc00{% else %}#ff0000{% endif %};"
                                    id="status-campanha-{{ campanha.id }}"
                                ></div>
                                <h2 id="nome-campanha-{{ campanha.id }}">{{ campanha.nome }}</h2>
                            </div>
                            <div class="tabela_campanha_conteudo_dado2">
                                <h2 id="data-fim-campanha-{{ campanha.id }}">{{ campanha.dataFim|date:"d/m/Y" }}</h2>
                                <button
                                    class="button-campanha"
                                    onclick="EditarCampanhas({{campanha.id}})"
                                    id="editar-campanha-{{ campanha.id }}"
                                >
                                    <img src="{% static 'api/img/edit.png' %}" alt="botao editar" />
                                </button>
                                {% comment %} <button
                                    class="button-campanha"
                                    onclick="inativarCampanhas({{campanha.id}})"
                                    id="excluir-campanha-{{ campanha.id }}"
                                >
                                    <img src="{% static 'api/img/iconeDeletar.png' %}" alt="deletar">
                                </button> {% endcomment %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>


            <div id="paginacao">
                <button id="botao-anterior" onclick="mudarPagina('predefinida', -1)">
                    <i class="fa fa-arrow-left"></i> 
                </button>
            
                <span class="spanFont">
                    Página <span id="pagina-atual-predefinida">1</span> 
                    de <span id="contador-de-pagina">5</span>
                </span>
            
                <button id="botao-proxima" onclick="mudarPagina('predefinida', 1)" >
                     <i class="fa fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

</div>

<script src="{% static 'api/js/AdmJS/criarCampanha.js' %}"></script>
<script>
    {% comment %} document.querySelectorAll('*').forEach(el => el.style.outline = '1px solid red'); {% endcomment %}

    const porPagina = 5;
    const paginas = { predefinida: 1, criada: 1 };
    

    function mostrarPagina(tipo) {
        const todasLinhas = document.querySelectorAll(`#corpo-tabela-${tipo} .tabela_campanha_conteudo`);
        const linhasVisiveis = Array.from(todasLinhas).filter(l => l.style.display !== 'none');

        const totalPaginas = Math.ceil(linhasVisiveis.length / porPagina);
        const paginaAtual = paginas[tipo];
    
        const inicio = (paginaAtual - 1) * porPagina;
        
        const fim = inicio + porPagina;
    
        todasLinhas.forEach(l => l.parentElement.style.display = 'none');
        linhasVisiveis.slice(inicio, fim).forEach(l => l.parentElement.style.display = '');
    
        // Atualiza número da página
        const elementoPagina = document.getElementById(`pagina-atual-${tipo}`);
        if (elementoPagina) {
            elementoPagina.textContent = paginaAtual;
        }
    
        // Mostrar/ocultar botões de paginação
        const botaoAnterior = document.getElementById(`botao-anterior`);
        const botaoProxima = document.getElementById(`botao-proxima`);
    
        if (botaoAnterior) {
            botaoAnterior.style.display = (paginaAtual === 1) ? 'none' : 'inline-block';
        }
        

        if (botaoProxima) {
            botaoProxima.style.display = (paginaAtual === totalPaginas) ? 'none' : 'inline-block';
        }


        function atualizarBotoes() {
            const paginaAtual = document.getElementById("pagina-atual-predefinida")?.textContent.trim();
            const totalPaginas = document.getElementById("contador-de-pagina")?.textContent.trim();

            if (!paginaAtual || !totalPaginas) return;

            if (paginaAtual === "1" && totalPaginas === "1") {
                botaoAnterior.style.display = "none";
                botaoProxima.style.display = "none";
            } else {
                botaoAnterior.style.display = (paginaAtual === "1") ? "none" : "inline-block";
                botaoProxima.style.display = (paginaAtual === totalPaginas) ? "none" : "inline-block";
            }
        }

        // Executa quando a página carrega
        atualizarBotoes();

        // Caso o texto do span mude dinamicamente
        const observer = new MutationObserver(atualizarBotoes);
        observer.observe(document.getElementById("pagina-atual-predefinida"), { childList: true });
        observer.observe(document.getElementById("contador-de-pagina"), { childList: true });
        
    }

    function mudarPagina(tipo, delta) {
        const linhas = document.querySelectorAll(`#corpo-tabela-${tipo} .tr-campanha`);

        const totalPaginas = Math.ceil(linhas.length / porPagina);
        console.log(totalPaginas)
        const novaPagina = paginas[tipo] + delta;
        console.log(novaPagina)

        if (novaPagina >= 1 && novaPagina <= totalPaginas) {
            paginas[tipo] = novaPagina;
            localStorage.setItem(`pagina-${tipo}`, novaPagina);
            mostrarPagina(tipo);
        }
    }

    function filtrarTabela(tipo, filtro) {
        const linhas = document.querySelectorAll(`#corpo-tabela-${tipo} .tr-campanha`);

        linhas.forEach(linha => {
            if (linha.textContent.toLowerCase().includes(filtro.toLowerCase())) {
                linha.style.display = '';
            } else {
                linha.style.display = 'none';
            }
        });
        mostrarPagina(tipo);
    }

    function buscarTabela(tipo) {
        const filtro = document.getElementById(`barraBusca`).value;
        filtrarTabela(tipo, filtro);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const todasLinhas = document.querySelectorAll(`#corpo-tabela-predefinida .tabela_campanha_conteudo`);
        const linhasVisiveis = Array.from(todasLinhas).filter(l => l.style.display !== 'none');

        const totalPaginas = Math.max(1, Math.ceil(linhasVisiveis.length / porPagina));

        const contadorDePagina = document.getElementById('contador-de-pagina');
        if (contadorDePagina) {
            contadorDePagina.textContent = totalPaginas;
        }

        const paginaSalva = parseInt(localStorage.getItem('pagina-predefinida')) || 1;
        paginas['predefinida'] = paginaSalva;
        mostrarPagina('predefinida');
        

        mostrarPagina('criada');
    });
    

    document.getElementById('barraBusca').addEventListener('input', function () {
        let termo = document.getElementById('barraBusca').value.toLowerCase();

        const linhas = document.querySelectorAll('.tabela_campanha_conteudo');

        linhas.forEach(linha => {
            const nome = linha.dataset.nome.toLowerCase();
            

            if (nome.includes(termo)) {
                this.parentElement
                
                linha.style.display = ''; // mostra
                

            } else {
                console.log("esconder")
                linha.style.display = 'none'; // esconde
            }
        });

        paginas['predefinida'] = 1;
        
        
        // Reaplica a paginação automaticamente
        mostrarPagina('predefinida'); // ou 'criadas' se for outra tabela
    });


</script>

{% endblock content %}
