{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/AdmCss/listaDePedidos.css'%}">
<link rel="stylesheet" href="{% static 'css/AdmCss/paginacao.css'%}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

{% include 'components/adm/menuAdm.html' %}

<div class="principal-listaDePedidos">
    <div class="detalhe-listaDePedidos">
        <form method="get">
        <div class="campo_pesquisar" id="campo-pesquisar">
            <div class="pesquisar">
                <img class="lupa" src="{% static 'img/pesquisa.png' %}" alt="" />
                    <input
                        type="search"
                        id="barraBusca"
                        name="search"
                        value="{{ search|default:'' }}"
                        placeholder="Pesquisar Campanha"
                    />
                    
                </div>
            </div>
        </form>
        <div class="cabecalho-listaDePedidos">
            <h1 class="Titulo-listaDePedidos">
                <p class="underline-listaDePedidos">Ped</p> <p>idos</p>
            </h1>

            <div class="butoes-listaDePedidos">
                <div class="button-listaDePedidos">
                    <a href="/listaDePedidos">
                        <button class="buttonPedidos-listaDePedidos">Visualizar Pedidos</button>
                    </a>
                </div>
                
                <div class="button-listaDePedidos">
                    <a href="/listaDePedidos?status=1">
                        <button class="buttonPedidos1-listaDePedidos">Visualizar Pedidos Concluídos</button>
                    </a>
                </div>
                
                <div class="button-listaDePedidos">
                    <a href="/listaDePedidos?status=2">
                        <button class="buttonPedidos2-listaDePedidos">Visualizar Pedidos Pendentes</button>
                    </a>
                </div>
            </div>
        </div>

        <div class="Produto-listaDePedidos">
            {% csrf_token %}
            {% for compra in compras %}
            <div class="linha-listaDePedidos" onclick="toggleItens('{{ compra.id }}')" style="cursor: pointer;" data-nome="{{ compra.idUsuario.first_name }}" >
                <div class="nome-listaDePedidos">
                    <img class="iconedigix-listaDePedidos" src="{% static 'img/digixlogo.png'%}" alt="icone">
                    <p>{{ compra.idUsuario.first_name }} - {{ compra.pedido }}</p>
                </div>
                <button 
                    class="btn-inativar-pedido" 
                    data-id="{{ compra.id }}" 
                    data-nome="{{ compra.idUsuario.first_name }}" title="Inativar/Excluir Pedido" 
                    title="Inativar/Excluir Pedido" 
                    onclick="event.stopPropagation();" 
                    style="background: none; border: none; padding: 0; cursor: pointer;"
                >
                    <img class="caminhao-listaDePedidos" src="{% static 'img/iconeDeletar.png' %}" alt="icone de inativação" >
                </button>
            </div>
            
            
            <div id="itens-{{ compra.id }}" class="itensCompra-listaDePedidos" style="display: none;">
                <strong>Itens da Compra:</strong>
                <div class='descricaoItensCompra-listaDePedidos'>
                    {% for item in pedidos %}
                        {% if item.idCompra.id == compra.id %}
                            <div class='infoItensCompra-listaDePedidos'>
                                {{ item.qtdProduto }} un. {{ item.idProduto.nome }} 
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <strong class="btn-itens-compra">Tipo: <span>{{ compra.entrega }}</span>

                
                {% if compra.pedido == 'Pendente' %}
                    {% if compra.entrega == 'Retirar' or compra.obsEntrega != 'False' %}
                        <button id="botaoConcluir">Concluir Pedido</button>
                        {% if compra.entrega == 'Entrega'   %}
                        <p class="endereco">{{ compra.rua }}, {{compra.numero}} - {{ compra.bairro }}, {{compra.cidade}} - {{compra.estado}}, {{compra.cep}} </p>
                        {% endif %}
                    {% elif compra.entrega == 'Entrega' and compra.obsEntrega == 'False' %}
   
                        <input type="text" class="obsEntrega" placeholder="Código de envio ou descrição">
                        <button id="botaoConcluir">Enviar Produto</button>
                        {% if compra.entrega == 'Entrega'   %}
                        <p class="endereco">{{ compra.rua }}, {{compra.numero}} - {{ compra.bairro }}, {{compra.cidade}} - {{compra.estado}}, {{compra.cep}} </p>
                        {% endif %}
                    {% endif %}
                {% else %}
                {% if compra.entrega == 'Entrega'   %}
                <p class="endereco">- {{ compra.rua }}, {{compra.numero}} - {{ compra.bairro }}, {{compra.cidade}} - {{compra.estado}}, {{compra.cep}} </p>
                {% endif %}
                {% endif %}

                
                </strong>
            </div>
            {% endfor %}
        </div>

        {% comment %} <div class="paginacao-div">
            <div class="paginacao-paginas">
                <div>
                    {% if compras.has_previous %}
                        <a class="botao-desativado-paginacao" href="?compra_page={{ compras.previous_page_number }}">
                            <i class="fa fa-arrow-left" aria-hidden="true"></i> 
                        </a>
                    {% else %}
                        <span class="botao-desativado-paginacao desativado">
                            <i class="fa fa-arrow-left" aria-hidden="true"></i> 
                        </span>
                    {% endif %}
                </div>
        
                <span>Página {{ compras.number }} de {{ compras.paginator.num_pages }}</span>
        
                <div>
                    {% if compras.has_next %}
                        <a class="botao-desativado-paginacao" href="?compra_page={{ compras.next_page_number }}">
                             <i class="fa fa-arrow-right" aria-hidden="true"></i>
                        </a>
                    {% else %}
                        <span class="botao-desativado-paginacao desativado">
                             <i class="fa fa-arrow-right" aria-hidden="true"></i>
                        </span>
                    {% endif %}
                </div>
            </div> {% endcomment %}

            <div class="pagination">
                {% if compras.has_previous %}
                <div class="paginas">
                    <a class="anterior" 
                       href="?compra_page={{ compras.previous_page_number }}&search={{ search }}&status={{ request.GET.status }}">
                        <i class="fa fa-arrow-left" aria-hidden="true"></i>
                    </a>
                </div>
                {% endif %}
                
                <span>Página {{ compras.number }} de {{ compras.paginator.num_pages }}</span>
                
                {% if compras.has_next %}
                <div class="paginas">
                    <a class="proxima" 
                       href="?compra_page={{ compras.next_page_number }}&search={{ search }}&status={{ request.GET.status }}">
                         <i class="fa fa-arrow-right" aria-hidden="true"></i>
                    </a>
                </div>
                {% endif %}
            </div>
            
        
        </div>
        
    </div>  
</div>
{% comment %} <script>
document.addEventListener('DOMContentLoaded', () => {
    const barraBusca = document.getElementById("barraBusca");
    const formBusca = barraBusca.closest('form');

    if (barraBusca) {
        // Mantém o foco e cursor se já houver texto
        if (barraBusca.value.trim() !== '') {
            barraBusca.focus();
            barraBusca.setSelectionRange(barraBusca.value.length, barraBusca.value.length);
        }

        // Submit apenas ao pressionar Enter
        barraBusca.addEventListener("keypress", (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // previne reload padrão
                sessionStorage.setItem('maintainFocus', 'true');
                sessionStorage.setItem('searchCursorPosition', e.target.selectionStart);
                formBusca.submit();
            }
        });

        // Mantém foco e cursor após reload/paginação
        if (sessionStorage.getItem('maintainFocus') === 'true') {
            barraBusca.focus();
            const savedPosition = sessionStorage.getItem('searchCursorPosition');
            if (savedPosition !== null) {
                barraBusca.setSelectionRange(
                    Math.min(parseInt(savedPosition), barraBusca.value.length), 
                    Math.min(parseInt(savedPosition), barraBusca.value.length)
                );
            }
            sessionStorage.removeItem('maintainFocus');
            sessionStorage.removeItem('searchCursorPosition');
        }
    }
});
</script> {% endcomment %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    const barraBusca = document.getElementById("barraBusca");
    if (!barraBusca) return;

    const formBusca = barraBusca.closest('form');
    const linhas = document.querySelectorAll(".linha-listaDePedidos");
    const paginacao = document.querySelector(".pagination");

    // Função de filtro otimizada
    function aplicarFiltro(termo) {
        termo = termo.toLowerCase().trim();
        requestAnimationFrame(() => {
            linhas.forEach(linha => {
                const nome = linha.dataset.nome.toLowerCase();
                linha.hidden = !(termo === "" || nome.includes(termo));
            });
            if (paginacao) {
                paginacao.style.display = (termo === "") ? "" : "none";
            }
        });
    }

    // Aplica filtro inicial se já tiver valor na barra
    aplicarFiltro(barraBusca.value);

    // Debounce para evitar submits a cada tecla
    let debounceTimer;
    barraBusca.addEventListener("input", (e) => {
        const valorAtual = e.target.value.trim();
        aplicarFiltro(valorAtual);

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            sessionStorage.setItem('maintainFocus', 'true');
            const cursorPosition = e.target.selectionStart;
            sessionStorage.setItem('searchCursorPosition', cursorPosition);
            formBusca.submit();
        }, 300); // espera 300ms sem digitar antes de enviar
    });

    // Enter também envia, mas sem travar o cursor
    barraBusca.addEventListener("keypress", (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const cursorPosition = e.target.selectionStart;
            sessionStorage.setItem('searchCursorPosition', cursorPosition);
            sessionStorage.setItem('maintainFocus', 'true');
            formBusca.submit();
        }
    });

    // Mantém foco e cursor após reload
    if (sessionStorage.getItem('maintainFocus') === 'true') {
        barraBusca.focus();
        const savedPosition = sessionStorage.getItem('searchCursorPosition');
        if (savedPosition !== null) {
            const pos = parseInt(savedPosition);
            barraBusca.setSelectionRange(pos, pos);
        }
        sessionStorage.removeItem('maintainFocus');
        sessionStorage.removeItem('searchCursorPosition');
    }
});
</script>


<script src="{% static 'js/AdmJS/listaDePedidos.js' %}"></script>

{% endblock content %}
